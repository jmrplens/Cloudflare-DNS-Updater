name: Build Binaries

on:
  push:
    branches: [ "main", "master", "refactor/*" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install SHC
        run: |
          sudo add-apt-repository ppa:neurobin/ppa -y
          sudo apt-get update
          sudo apt-get install -y shc

      - name: Bundle Script
        run: bash tools/bundle.sh

      - name: Compile Linux Binary
        run: |
          shc -r -f dist/cloudflare-dns-updater-monolith.sh -o dist/cf-updater-linux
          chmod +x dist/cf-updater-linux

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v6
        with:
          name: cf-updater-linux
          path: dist/cf-updater-linux

  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install SHC
        run: brew install shc

      - name: Bundle Script
        run: bash tools/bundle.sh

      - name: Compile Mac Binary
        run: |
          shc -r -f dist/cloudflare-dns-updater-monolith.sh -o dist/cf-updater-mac
          chmod +x dist/cf-updater-mac

      - name: Upload Mac Artifact
        uses: actions/upload-artifact@v6
        with:
          name: cf-updater-mac
          path: dist/cf-updater-mac

  build-windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Compilers
        run: |
          sudo add-apt-repository ppa:neurobin/ppa -y
          sudo apt-get update
          sudo apt-get install -y shc gcc-mingw-w64

      - name: Bundle Script
        run: bash tools/bundle.sh

      - name: Compile Windows Binary (Cross-Compile)
        run: |
          # Generate C source
          shc -r -f dist/cloudflare-dns-updater-monolith.sh
          # Source is now in dist/cloudflare-dns-updater-monolith.sh.x.c
          
          # Patch C source to rely on PATH for shell (replace /bin/sh with sh) if strict pathing causes issues,
          # but shc usually handles this logic. Alternatively, we just compile and hope MinGW handles the exec call.
          # Compiling with MinGW
          x86_64-w64-mingw32-gcc dist/cloudflare-dns-updater-monolith.sh.x.c -o dist/cf-updater.exe
          
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v6
        with:
          name: cf-updater-windows
          path: dist/cf-updater.exe

  release:
    needs: [build-linux, build-mac, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/cf-updater-linux
            artifacts/cf-updater-mac
            artifacts/cf-updater.exe
